<!DOCTYPE html>
<html>
<head>
    <title>Copying...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; color: #f5f5f5; background-color: #17212b; }
        p { font-size: 16px; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <p id="status">Đang chuẩn bị để sao chép...</p>

    <script>
        // Sử dụng window.onload để đảm bảo tất cả tài nguyên trang đã được tải
        window.onload = function() {
            const statusElement = document.getElementById('status');
            
            try {
                const WebApp = window.Telegram.WebApp;
                WebApp.ready();

                // Lấy dữ liệu cần sao chép (kết hợp cả 2 cách để an toàn)
                let rawData = WebApp.initDataUnsafe.start_param;
                if (!rawData && window.location.hash.length > 1) {
                    rawData = window.location.hash.substring(1);
                }

                if (rawData) {
                    // "Làm sạch" dữ liệu
                    const junkMarker = '?tgWebAppData';
                    const junkIndex = rawData.indexOf(junkMarker);
                    let cleanText = (junkIndex !== -1) ? rawData.substring(0, junkIndex) : rawData;
                    const finalTextToCopy = decodeURIComponent(cleanText);

                    // === PHẦN QUAN TRỌNG NHẤT: TRÌ HOÃN HÀNH ĐỘNG ===
                    // Chúng ta đợi 100 mili giây (0.1 giây) trước khi sao chép.
                    // Khoảng thời gian này đủ để cửa sổ Web App được "focus".
                    setTimeout(function() {
                        statusElement.innerText = "Đang sao chép...";
                        
                        navigator.clipboard.writeText(finalTextToCopy).then(function() {
                            statusElement.innerText = "Đã sao chép thành công!";
                            WebApp.HapticFeedback.notificationOccurred('success');
                            
                            // Tự động đóng sau khi thành công
                            setTimeout(() => WebApp.close(), 400);

                        }).catch(function(err) {
                            statusElement.innerText = "Lỗi sao chép tự động.\nVui lòng thử lại.";
                            // Nếu thất bại, chúng ta không tự đóng để người dùng thấy lỗi
                        });
                    }, 100); // <-- Độ trễ 100ms

                } else {
                    statusElement.innerText = "Không tìm thấy nội dung để sao chép.";
                     setTimeout(() => WebApp.close(), 1000);
                }

            } catch (e) {
                statusElement.innerText = "Lỗi: Vui lòng mở từ Telegram.";
            }
        };
    </script>
</body>
</html>
