<!DOCTYPE html>
<html>
<head>
    <title>Copying...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; color: #f5f5f5; background-color: #17212b; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <p id="status">Đang khởi tạo...</p>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('status');
            
            try {
                const WebApp = window.Telegram.WebApp;
                WebApp.ready();
                statusElement.innerText = "Đang lấy dữ liệu...";

                // === LOGIC MỚI: ĐỌC TỪ HASH VÀ LÀM SẠCH NÓ ===
                
                // 1. Lấy toàn bộ phần hash (bắt đầu bằng #)
                let rawHash = window.location.hash;

                if (rawHash && rawHash.length > 1) {
                    // Bỏ dấu # ở đầu
                    let textWithJunk = rawHash.substring(1);
                    
                    // 2. Làm sạch dữ liệu thừa
                    const junkMarker = '?tgWebAppData';
                    const junkIndex = textWithJunk.indexOf(junkMarker);

                    let cleanText;
                    if (junkIndex !== -1) {
                        cleanText = textWithJunk.substring(0, junkIndex);
                    } else {
                        cleanText = textWithJunk;
                    }

                    // 3. Giải mã URL để có được chuỗi gốc
                    const finalTextToCopy = decodeURIComponent(cleanText);

                    // 4. Sao chép chuỗi đã được làm sạch và giải mã
                    statusElement.innerText = "Đang sao chép...";
                    navigator.clipboard.writeText(finalTextToCopy).then(function() {
                        if (WebApp.isVersionAtLeast('6.1')) {
                            WebApp.showAlert('Đã sao chép link thành công!');
                        }
                        setTimeout(() => WebApp.close(), 200);

                    }).catch(function(err) {
                        if (WebApp.isVersionAtLeast('6.1')) {
                            WebApp.showAlert('Lỗi: Không thể sao chép. ' + err);
                        }
                        setTimeout(() => WebApp.close(), 500);
                    });
                } else {
                    // Trường hợp không có hash
                    if (WebApp.isVersionAtLeast('6.1')) {
                        WebApp.showAlert('Lỗi: Không tìm thấy nội dung hash để sao chép.');
                    }
                    setTimeout(() => WebApp.close(), 500);
                }

            } catch (e) {
                statusElement.innerText = "Lỗi: Vui lòng mở từ ứng dụng Telegram. " + e.message;
            }
        });
    </script>
</body>
</html>
